## async 和 defer

面试常见考点：为什么 `<script>` 会阻塞渲染？`async`、`defer` 分别如何改变加载与执行时机？下面从浏览器解析流程、三种策略对比以及实践建议逐层梳理。

### 基础概念

默认情况下（未加 `async`/`defer`）：
- HTML 解析过程中遇到 `<script>` 会立即暂停，先下载脚本；
- 脚本下载完成后马上执行，执行期间 HTML 解析与 CSS 解析都会停下；
- 下载阶段与 CSS 资源可以并行，但执行阶段必须等脚本执行完。

因此需要异步策略减少阻塞。

### 三种加载策略对比

| 策略 | 加载时机 | 执行时机 | 执行顺序 | 是否阻塞 HTML 解析 | 典型场景 |
| --- | --- | --- | --- | --- | --- |
| 默认 | 遇到脚本标签立即开始 | 下载一完成立刻执行 | 按在文档中的顺序 | 加载会暂停 HTML，执行必定阻塞 | 需要同步执行的内联/初始化脚本 |
| `async` | 与 HTML 解析并行下载 | 下载一完成立刻执行 | 谁先下完谁先执行 | 执行阶段会阻塞 HTML | 独立脚本：埋点、广告、第三方 SDK |
| `defer` | 与 HTML 解析并行下载 | DOM 全部解析完毕，`DOMContentLoaded` 触发前 | 严格遵循文档顺序 | 不阻塞 HTML 解析 | 依赖 DOM 结构但不依赖运行时数据的脚本，如页面初始化 |

> 记忆口诀：`async` 强调“加载快就执行”，`defer` 强调“等 DOM 好了再按顺序执行”。

### 事件与顺序示意

1. 浏览器开始解析 HTML。
2. 遇到带 `async`/`defer` 的脚本：继续解析 HTML，同时在后台下载脚本。
3. `async` 脚本下载完成 → 立即执行 → 执行期间会短暂阻塞解析。
4. HTML 解析完成 → 触发 `DOMContentLoaded` 之前按顺序执行所有 `defer` 脚本。
5. 所有脚本执行完 → 页面进入交互阶段。

### CSS 与脚本的协作

1. **下载阶段**  
   HTML、CSS、JavaScript 都可以同时从网络下载，谁先返回谁先完成，不互相等待。

2. **解析阶段**  
   - 浏览器需要先构建 DOM（HTML）和 CSSOM（CSS）再合成渲染树。  
   - `<script>` 可能读取或修改样式，因此浏览器会等**相关 CSS 解析完**再执行脚本，避免出现“脚本依赖的样式还没准备好”的情况，也避免反复重排。

3. **顺序建议**  
   将 `<link rel="stylesheet">` 放在 `<script>` 上方，确保 CSS 解析优先完成。这样脚本执行时能拿到最终样式，页面不会闪烁或出现样式突变。

> 面试话术：资源下载是并行的，但解析执行存在依赖。CSS 可能阻塞脚本执行，脚本也会暂停 HTML 解析，合理的标签顺序能减少互相等待。

### 使用建议

**优先使用 `defer`**
- 适用于大多数需要 DOM 支持的业务脚本；
- 保证执行顺序，易于维护；
- 不影响首屏解析。

**谨慎使用 `async`**
- 适合互不依赖的独立脚本（统计、广告、第三方 SDK）；
- 需要确保不依赖 DOM 或其他脚本结果。

**必要时保留同步脚本**
- 页面关键初始化、polyfill 或必须在首屏前执行的逻辑；
- 数量越少越好，可考虑内联并配合 `type="module"`。

### 面试小结

1. 未加属性会阻塞 HTML 解析；`async`/`defer` 是为了解决这一性能瓶颈。
2. `async` 抢时间、强调加载即执行；`defer` 保顺序、强调 DOM Ready 后执行。
3. 合理组合 `link`、`async`、`defer` 是前端首屏优化的基础题。
