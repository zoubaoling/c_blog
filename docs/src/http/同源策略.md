## 什么是同源策略？

> **判定标准**：协议（scheme）+ 域名（host）+ 端口（port）三者都相同才同源；任一不同即跨域。

| 示例 | 是否同源 | 差异点 |
| --- | --- | --- |
| `https://www.example.com:443/page` vs `https://www.example.com:443/data` | ✅ | 仅路径不同 |
| `http://www.example.com:80` vs `https://www.example.com:443` | ❌ | 协议、端口不同 |
| `https://api.example.com` vs `https://www.example.com` | ❌ | 子域名不同 |

### 为什么需要同源策略
- 防止恶意页面在用户不知情的情况下读取/操作另一个站点的数据。
- 避免 CSRF、敏感信息泄露（cookie、localStorage、DOM）。
- 浏览器层面的安全沙箱机制；服务器端仍会收到请求，只是响应会被浏览器拦截。

### 浏览器限制了什么
1. **DOM 访问**：不同源的 iframe、window 无法互相读写 DOM。
2. **存储**：`cookie`、`localStorage`、`IndexedDB` 等无法互通。
3. **AJAX 响应**：跨域 `XMLHttpRequest/fetch` 可发送，但响应会被拦截（除非后端允许）。
4. **资源标签例外**：`<img>`、`<link>`、`<script>` 可跨域加载（用于 JSONP、CDN 资源等）。

### 常见跨域解决方式
1. **CORS（推荐）跨域资源共享**
   - 服务器在响应头设置 `Access-Control-Allow-Origin`、`Access-Control-Allow-Methods`、`Access-Control-Allow-Headers` 等。
   - 区分 **简单请求** 和 **预检请求（OPTIONS）**。
   - 若需要携带 Cookie：前端 `withCredentials = true`，后端设置 `Access-Control-Allow-Credentials: true` 且 `Allow-Origin` 不能为 `*`。
2. **JSONP（历史方案）**
   - 利用 `<script>` 标签不受同源限制的特性，仅支持 GET，请求参数约定 `callback`。
   - 有 XSS 风险，现代项目少用。
   ```html
   <!-- 前端 -->
   <script>
   function handleData(data) {
     console.log('JSONP response:', data)
   }
   const script = document.createElement('script')
   script.src = 'https://api.example.com/list?type=news&page=1&callback=handleData'
   document.body.appendChild(script)
   </script>

   <!-- 服务端返回 -->
   handleData({ code: 0, list: [...] })
   ```
3. **反向代理（服务器代理）**
   - 通过 Nginx、Node 中间层把跨域请求转发到目标域，前端对同一域发请求即可。
   - 本质是“服务端代发”，开发环境常用（如 Vite `proxy`）。
4. **postMessage**
   - 用于跨窗口、iframe 通信，显式指定接收方源；配合事件监听获取数据。
5. **WebSocket**
   - 不受同源策略限制，但服务器可校验 `Origin` 以控制访问。
6. **其他**：`document.domain`（仅限同一主域）、`window.name`、`iframe + location.hash`（历史方案，不推荐）。

### 面试回答模板
1. 定义同源策略 + 举例说明判定标准。
2. 说明目的：保护用户数据安全，浏览器层防御。
3. 列出限制类型：DOM、存储、AJAX 等。
4. 给出常见解决方案（重点讲 CORS，顺带提 JSONP、代理、postMessage、WebSocket）。
5. 如果有项目实践，可分享具体配置或踩坑（例如携带 Cookie 的 CORS、预检请求缓存等）。

### 参考链接
- [MDN 同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy)
- [MDN CORS](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)